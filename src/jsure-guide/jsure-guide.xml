<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
"../../lib/docbook-xml-4.5/docbookx.dtd">

<book id="jsure-examples" lang="en-US"
    xmlns:xi="http://www.w3.org/2001/XInclude">
  <title>JSure User Guide</title>
  <subtitle>How to use and configure the JSure Eclipse client</subtitle>
  <bookinfo>
    <copyright>
      <year>2009</year>
      <holder>SureLogic, Inc.</holder>
    </copyright>
    <legalnotice>
      <para>The authors and publishers have taken care in the
      preparation of this documentation, but make no expressed or
      implied warranty of any kind and assume no responsibility for
      errors and omissions. No liability is assumed for incidental or
      consequential damages in connection with or arising out of the use
      of the information or programs herein.</para>
    </legalnotice>
    <pubdate>Version 3.0.0&mdash;November 2009</pubdate>
  </bookinfo>

  <preface id="preface">
    <title>Preface</title>
    <sect1>
      <title>Audience</title>
      <para>This document is intended for Java developers who want to
      use the JSure tool within the Eclipse Java IDE. We assume
      that the reader understands both the Java programming language and
      the use of Eclipse for Java development.</para>
    </sect1>
    <sect1>
      <title>Contact information</title>
      <para>For technical support or other questions, please
      contact:</para>
      <para><email>support@surelogic.com</email></para>
      <para>5808 Forbes Avenue, Pittsburgh, PA 15217-1602</para>
    </sect1>
  </preface>

  <xi:include href="chapter-getting-started/chapter.xml"/>

  <xi:include href="chapter-understanding-assurance-output/chapter.xml"/>

  <xi:include href="chapter-reference/chapter.xml"/>

  <chapter>
    <title>Release notes</title>
    <para>For each release of JSure there are new and noteworthy
    features to try out, and known limitations to avoid or
    workaround. These are presented in the sections below for each
    released version of JSure.</para>

    <section id="sec-jsure-release-3-1-0">
      <title>JSure version 3.1.0</title>
      <para>This section describes the 3.1.0 version of the JSure Eclipse client.</para>
      <section>
	<title>New and Noteworthy</title>

	<para>This section describes new and noteworthy features in this
	version of JSure.</para>
	<orderedlist>
	  <listitem><para><emphasis>@Unique("return") on constructors?</emphasis> &mdash;
            </para>
	  </listitem>
	  <listitem><para><emphasis>Turn off analysis for test directories??</emphasis> &mdash;
              If your project includes source directories for test code, you can setup your project
	      to ignore those directories by adding a "jsure.properties" file with the following contents
              to the project root:
<programlisting>
# A comma-separated list of source paths
ModuleDecl.Test=src/java/test/*,src/test/*
# Load only interfaces, not method bodies
Module.asClass=Test
# Load on demand from other classes
Module.asNeeded=Test
# Load everything else as usual
Module.defaults=asSource
</programlisting>
            </para>
	  </listitem>
	  <listitem><para><emphasis>Use JSure annotations in Javadoc under Java 1.4</emphasis> &mdash;
              For those developers still wedded to using Java 1.4 or below, JSure supports putting 
	      promises in Javadoc, instead of using the Java 5 annotations.  See the help documents for 
              more details: 
<programlisting>
    /**
     * @annotate @RegionLock("SimpleLock is this protects Instance")
     */
</programlisting>
            </para>
	  </listitem>
	  <listitem><para><emphasis>Improved JSure job progress</emphasis> &mdash;
	      Progress updates have been added to longer-running analyses to provide better feedback
	      as to what JSure is doing.
            </para>
	  </listitem>
	  <listitem><para><emphasis>Quickly copy text for problem/improvement reports</emphasis> &mdash;
	      To simplify reporting, you can now copy text from the Verification Status view.
	      In addition, the reporting dialogs no longer block operations in the Eclipse IDE, 
	      so you can take full advantage of the IDE to compose your reports.
            </para>
	  </listitem>
	</orderedlist>
      </section>
    </section>

    <section id="sec-jsure-release-3-0-0">
      <title>JSure version 3.0.0</title>
      <para>This section describes the 3.0.0 version of the JSure Eclipse client.</para>
      <section>
	<title>New and Noteworthy</title>

	<para>This section describes new and noteworthy features in this
	version of JSure.</para>
	<orderedlist>
	  <listitem>
	    <para><emphasis>A more straightforward aggregation
	    syntax</emphasis> &mdash; The syntax of aggregation is
	    improved. Many programmers have found found
<programlisting>
@RegionLock("CLock is this protects Instance")
class C {
  @Unique
  @Aggregate("Instance into Instance")
  private final Set&lt;String&gt; cSet = new HashSet&lt;String&gt;();
  &hellip;
}
</programlisting>
to be confusing and too academic-looking. This syntax is still
accepted by JSure (for backwards compatibility), however, it can be
simplified to
<programlisting>
@RegionLock("CLock is this protects Instance")
class C {
  @Unique
  @Aggregate
  private final Set&lt;String&gt; cSet = new HashSet&lt;String&gt;();
  &hellip;
}
</programlisting>
when dealing the <code>Instance</code> region (indicating all the
declared fields in the object). If the region is named then you can
use
<programlisting>
@Region("private CRegion")
@RegionLock("CLock is this protects CRegion")
class C {
  @Unique
  @AggregateInRegion("CRegion")
  private final Set&lt;String&gt; cSet = new HashSet&lt;String&gt;();
 
  @InRegion("CRegion")
  private int counter;
  &hellip;
}
</programlisting>
             which is similar to the <code>@InRegion</code>
             annotation (as seen above for the counter field).</para>
	  </listitem>
	  <listitem>
	    <para><emphasis>Goetz/Perlis annotation support</emphasis>
	    &mdash; We now support three of the four Goetz/Perlis
	    annotations: <code>@ThreadSafe</code>,
	    <code>@NotThreadSafe</code>, and
	    <code>@Immutable</code>. (We have some work to do with
	    <code>@GuardedBy</code>, but that annotation is really an
	    impoverished version of <code>@RegionLock</code>.)
	    Primarily these are for code documentation purposes. The
	    <code>@SelfProtected</code> annotation is replaced by
	    <code>@ThreadSafe</code>, therefore, if any
	    <code>@SelfProtected</code> annotations are in the code
	    they will not compile with the new JAR and will need to be
	    changed to <code>@ThreadSafe</code>. We decided to make
	    this, sadly incompatible, change to better support
	    standard annotations. It is our intention to fully support
	    all the standard Goetz/Perlis annotations in JSure.</para>

	    <para>The <code>@Immutable</code> annotation is not
	    verified in this release but an analysis will be added to
	    support verification of this assertion in a future release
	    of JSure.</para>
	  </listitem>
	  <listitem><para><emphasis>@MapFields replaced by
	  @InRegion</emphasis> &mdash; Another incompatible change is
	  the replacement of the <code>@MapFields</code> annotation
	  and its associated plural <code>@MapsFields</code> with
	  <code>@InRegion</code> and <code>@InRegions</code>,
	  respectively. This annotation was out of date (older
	  annotations talked about mapping fields into a region) and
	  we wanted to updated it and make it consistent with the
	  scheme used to allow multiple annotations on a class.</para>
	  <para>For example, one would change the below annotations
<programlisting>
/**
 * FSEditLog maintains a log of the namespace modifications.
 */
@Region("LogState")
@RegionLock("LogLock is this protects LogState")
@MapFields("editStreams, fsimage into LogState")
public class FSEditLog { ... }
</programlisting>
to
<programlisting>
/**
 * FSEditLog maintains a log of the namespace modifications.
 */
@Region("LogState")
@RegionLock("LogLock is this protects LogState")
@InRegion("editStreams, fsimage into LogState")
public class FSEditLog { ... }
</programlisting>
</para>
	  </listitem>
	  <listitem><para><emphasis>Programmer vouch capability added
	  to JSure</emphasis> &mdash; Vouches for any any inconsistent
	  analysis result within the scope of code that the annotation
	  appears on. This means that any inconsistent result will be
	  changed to a consistent result. Its use is for documentation
	  and to quiet overly conservative analysis results. This
	  annotation is trusted, i.e., it is not verified by
	  analysis.</para>

	  <para>The annotation requires a brief programmer explanation
	  for the vouch being made.</para>

	  <para>For example, an <code>init</code> method is used to
	  set set state, perhaps due to an API restriction about using
	  constructors, then <code>CentralControl</code> instances are
	  safely published. A <code>@Vouch</code> annotation is used
	  to explain that the <code>init</code> method needs to be an
	  exception to the lock policy.
<programlisting>
 @Region("private ControlRegion")
 @InRegion("f_id into ControlRegion")
 @RegionLock("ControlLock is lock protects ControlRegion")
 public class CentralControl {
 
   private final Object lock = new Object();
   private String f_id;
 
   @Vouch("Instances are thread confined until after init(String) is called.")
   public void init(String id) {
     f_id = id;
   }
 
   public String getId() {
     synchronized (lock) {
       return f_id;
     }
   }
 
   public void setId(String value) {
     synchronized (lock) {
       f_id = value;
     }
   }
 }
</programlisting>
	  Notice that the current implementation vouches for all
	  inconsistent analysis results within the type or method or
	  constructor that the annotation appears on. A more targeted
	  capability will be introduced in a future version of
	  JSure.</para>
	  </listitem>
	  <listitem>
	    <para><emphasis>Main menu item to add the JSure
	    annotations to a project</emphasis> &mdash; It is now
	    possible to add or update the JSure annotations library to
	    a project from the Eclipse main menu as shown in <xref
	    linkend="fig-release-notes-300-add-jar"/>
	    <figure id="fig-release-notes-300-add-jar">
	      <title>Main menu item to add the JSure annotations to a project</title>
	      <mediaobject>
		<imageobject><imagedata fileref="images/release-notes-300-add-jar.png"/></imageobject>
	      </mediaobject>
	    </figure>
	    It is a good idea to run this menu choice after you
	    install a new version of JSure to ensure the annotation
	    library is up to date. If there is not an update the tool
	    will tell you you are up-to-date.
	    </para>
	  </listitem>
	  <listitem>
	    <para><emphasis>JSure annotations submitted to the Maven
	    Central Repository</emphasis> &mdash; SureLogic has
	    submitted the updated promise syntax (as described above)
	    to the Maven central repository and is awaiting them to
	    perform the upload request. The JIRA is <ulink
	    url="http://jira.codehaus.org/browse/MAVENUPLOAD-2654">http://jira.codehaus.org/browse/MAVENUPLOAD-2654</ulink>.
	    The maven site for JSure is <ulink
	    url="http://surelogic.com/promises/index.html">http://surelogic.com/promises/index.html</ulink>
	    with the associated Javadoc at <ulink
	    url="http://surelogic.com/promises/apidocs/index.html">http://surelogic.com/promises/apidocs/index.html</ulink>. This
	    inclusion in the Maven Central Repository is a step toward
	    making the JSure annotations a Java standard for
	    documenting and verifying concurrency design intent.
</para>
	  </listitem>
	</orderedlist>
      </section>

      <section>
	<title>Known Problems</title>
	<para>This section describes known bugs and limitations in this
	version of JSure.</para>
	<orderedlist>
	  <listitem><para><emphasis>Small <wordasword>S</wordasword>
	  in the project icon lower right corner does not go away when
	  JSure is disabled</emphasis> &mdash; JSure can only assure
	  the contents of one project at a time. The icon of the
	  project being assured is marked with a small
	  <wordasword>S</wordasword> in the lower right corner:
	  <guiicon><inlinegraphic
	  fileref="images/jsure-nature.png"/></guiicon>. The
	  <wordasword>J</wordasword> above the
	  <wordasword>S</wordasword> are intended to remind you that
	  this is the project JSure is analyzing. Sometimes when you
	  disable JSure verification the small
	  <wordasword>S</wordasword> does not go away immediatly. This
	  is a refresh bug in Eclipse. To make it go away simply
	  refresh the project (with F5) or restart Eclipse.</para>
	  </listitem>
	  <listitem><para><emphasis>Incremental analysis sometimes
	  fails</emphasis> &mdash; In rare cases the incremental
	  analysis, i.e., the results update when you save, fails. A
	  workaround is to restart Eclipse or perform a
	  <menuchoice><guimenuitem>Project</guimenuitem><guimenuitem>Clean...</guimenuitem></menuchoice>
	  of the project being verified. If this problem occurs please
	  notify SureLogic.</para>
	  </listitem>
	  <listitem><para><emphasis>Analysis can sometimes be
	  slow</emphasis> &mdash; If JSure verification is slow on
	  your computer, please notify SureLogic. It is suggested that
	  you only turn on JSure when you are using it. Another
	  workaround is to disable the automatic building of your code
	  in Eclipse by unchecking
	  <menuchoice><guimenuitem>Project</guimenuitem><guimenuitem>Build
	  Automatically</guimenuitem></menuchoice> in Eclipse. This
	  lets you select
	  <menuchoice><guimenuitem>Project</guimenuitem><guimenuitem>Build
	  Project</guimenuitem></menuchoice> to run the Java compiler
	  and JSure only when you are ready to.</para>
	  </listitem>
	</orderedlist>
      </section>
    </section>

    <section id="sec-jsure-release-2-3-0">
      <title>JSure version 2.3.0</title>
      <para>This section describes the 2.3.0 version of the JSure Eclipse client.</para>
      <section>
	<title>New and Noteworthy</title>

	<para>This section describes new and noteworthy features in this
	version of JSure.</para>
	<orderedlist>
	  <listitem>
	    <para><emphasis>Verification results are now separated
	    from modeling problems</emphasis> &mdash; A new view,
	    called the <guilabel>Modeling Problems</guilabel> view,
	    has been added to JSure. Previously any annotations that
	    were not well-formed (i.e., they had syntax errors or
	    other problems) were reported as modeling problems in the
	    <guilabel>Verification Status</guilabel> view. This was
	    confusing to the user because these results, which are
	    very important, could easily be missed when mixed in with
	    the analysis results shown in this view. A screenshot
	    showing this new view noting a typo in a
	    <emphasis>@InRegion</emphasis> annotation is shown in
	    <xref
	    linkend="fig-release-notes-230-modeling-problems"/>. The
	    referenced region name should be "PrivateState" not
	    "PrivateeState".</para>
	    <figure id="fig-release-notes-230-modeling-problems">
	      <title>The new Modeling Problems view</title>
	      <mediaobject>
		<imageobject><imagedata fileref="images/release-notes-230-modeling-problems.png"/></imageobject>
	      </mediaobject>
	    </figure>
	    <para>The new view, by default, appears when the code has
	    any modeling problems. Therefore, the view can be
	    dismissed to save screen space and it will come back when
	    needed. This behavior can be changed as shown in  <xref
	    linkend="fig-release-notes-230-modeling-problems-pref"/>.</para>
	    <figure id="fig-release-notes-230-modeling-problems-pref">
	      <title>Preference for the new Modeling Problems view</title>
	      <mediaobject>
		<imageobject><imagedata fileref="images/release-notes-230-modeling-problems-pref.png"/></imageobject>
	      </mediaobject>
	    </figure>
	  </listitem>
	  <listitem>
	    <para><emphasis>Quickly create tutorial projects</emphasis> &mdash;
	    You can now create the SmallWorld and ShowOff tutorial projects from
	    the Findings Quick Search menu.</para>
	  </listitem>
	</orderedlist>
      </section>
    </section>
  </chapter>
</book>
